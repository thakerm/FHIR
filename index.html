<!-- index.html -->
<script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script>

    FHIR.oauth2.ready().then(smart => { //starting in version 2.5 must use then or catch to get the smart object
        /* console.log("Smart", smart);
        patient = smart.patient;
        console.log("Patient", patient);
        pt = patient.read();
        console.log("Pt", pt); */


       /*  smart.patient.request("Observation?code=http://loinc.org|2857-1").then(function (obv) {
            console.log("I am in");
            table = document.getElementById("PSA");
            console.log("obv", obv);
            len = obv.entry.length;
            console.log("len", len);

            for (i = 0; i < len; i++) {
                //create new 
                table += "<tr><td>" + obv.entry[i].resource.valueQuantity.value + "</td></tr>";
                //table += "<tr>"+"Hi"+"</tr>";

            }
            //append table to html
            $("#PSA").append(table);
        }).catch(console.error); */

        //request all available labratory data for selected patient

    smart.patient.request({
            resourceType: 'Observation',
            params: {
                category: 'laboratory'
            }
        }).then(function (response) {
            var observations = response.entry;
            observations.forEach(function (entry) {
                var observation = entry.resource;
                // Extract the relevant information from the observation
                var value = observation.valueQuantity.value;
                var unit = observation.valueQuantity.unit;
                var date = observation.effectiveDateTime;

                // Append the data to the #labData element
                $("#labData").append("<tr><td>" + value + "</td><td>" + unit + "</td><td>" + date + "</td></tr>");
            });
        }).catch(function (error) {
            console.error('Error:', error);
        }); 


        /* $.when(patient).done(function (patients) {
            var fname = '';
            var lname = '';
            patientID = smart.patient.id;
            console.log("Patient ID", patientID);
            gender = patients.gender
            age = patients.birthDate;
            console.log(gender)
            document.getElementById("name").innerHTML = "Welcome " + patients.name[0].given[0] + " " + patients.name[0].family;
            document.getElementById("gender").innerHTML = gender;
            document.getElementById("age").innerHTML = age;



        }).catch(console.error); */

    })
        .catch(console.error);

</script>

<html>

<head>
    <title>SMART on FHIR App</title>
</head>

<body>
    <h1 id="name"></h1>
    <p id="gender"></p>
    <p id="age"></p>
    <table id="PSA">

    </table>
    <table id="labdata"></table>
</body>

</html>